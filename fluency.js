const FLUENCY_PASSAGES = [
    {
        id: 'cvc-picnic',
        title: 'CVC Picnic',
        gradeBand: 'K-2',
        lexileBand: 'Emergent',
        focus: 'CVC words',
        passage: `Sam sat on the mat. Pam sat with him. They had a big red bag.

Pam set the bag on the grass. Sam put a cup by the bag. Pam got a lid and a nap.
"Let's pack up," said Pam. Sam did a quick check. He had a jam bun. Pam had a ham sub.

Then Sam saw a cat. The cat ran up and sat. "Hi, cat," said Sam. The cat did not hiss. It just sat.
Pam had a tip. "Do not toss food," she said. "We can pick a bit for the cat."

Sam tore a small bit of ham. The cat took it and ran. Then the cat came back with a pal.
Now Sam saw two cats. Sam held his cup. "Oh!" he said. Pam just giggled.

The wind hit the bag. The bag slid a bit. Sam ran and got it. He put a rock on top.
"Good job," said Pam. "We can sit and chat."

They ate and sipped. They did not rush. Sam felt glad. Pam felt glad, too.
At last, the sun got hot. "Time to hop," said Pam. Sam shut the bag and did a quick lap to pick up trash.
They went home and felt proud of their picnic plan.`
    },
    {
        id: 'short-vowels-trip',
        title: 'Short Vowel Trip',
        gradeBand: 'K-2',
        lexileBand: 'Emergent',
        focus: 'Short vowels',
        passage: `Jen went on a trip with her class. The bus was big. The seats were soft.
Jen sat by Ben. Ben had a red pen and a map.

The bus went up a hill. It hit a bump. Jen held on and did not slip.
"We will stop soon," said the driver. Jen felt a bit of fizz in her chest. She was glad.

At the park, the class had a list. "Find a bug," said the list. "Find a rock. Find a stick."
Jen got a stick. Ben got a rock. Kim got a bug in a jar.

Then the class did a quick jog. They ran past a pond. They saw a duck.
The duck did a dip. It got wet. Jen said, "Look! The duck can swim!"

On the way back, the wind was brisk. Jen put on her hat. Ben sat and drank from his cup.
"This trip was fun," said Ben. Jen nodded. "Yes," she said. "It was the best!"`
    },
    {
        id: 'digraph-day',
        title: 'Digraph Day',
        gradeBand: 'K-2',
        lexileBand: 'Emergent',
        focus: 'Digraphs (sh, ch, th, ng)',
        passage: `"Shh," said Ms. Chen. "We will play a digraph game."

First, the class made a wish list. "I wish for a fish," said Josh.
"I wish for a shell," said Beth. "I wish for a chip," said Chip.
Ms. Chen smiled. "We can shop for words," she said.

At the word shop, the kids had to match tiles. One tile said SH. One said CH. One said TH.
Josh found SHIP. Beth found SHOP. Chip found CHIN.

Then Ms. Chen held up a thin strip of cloth. "This is thin," she said. "Th... th... thin."
The kids tried it. "Th... thin," they said. Then she held up a thick book. "Th... thick."
They giggled. "Thick!" said Josh.

Next, they listened for /ng/. Ms. Chen rang a bell. "Ring," she said. "Sing," said Beth.
Chip said, "I can bring my sling!" Ms. Chen laughed. "Nice /ng/ words!"

At the end, each kid chose one digraph and wrote a short note.
Josh wrote, "I can fish."
Beth wrote, "I can shop."
Chip wrote, "I can sing."
Ms. Chen said, "Great work. You can hear the sounds and match the letters."`
    },
    {
        id: 'magic-e-maze',
        title: 'Magic E Maze',
        gradeBand: 'K-2',
        lexileBand: 'Emergent',
        focus: 'Magic E (CVCe)',
        passage: `Lina and Miles made a maze in the sand. They used a rake to make lines.

"Pick a word," said Lina. "If you read it, you can take a step."
Miles picked a card that said CAP. He read it fast. "Cap!" he said. He took one step.

Next card: CAPE. Miles blinked. "Cape," he said. "The e is quiet, but it makes the vowel say its name."
Lina nodded. "Nice."

They kept going.
"Kit... kite."
"Pin... pine."
"Tap... tape."
"Hop... hope."

Sometimes they made a quick sketch for the word. A kite in the sky. A cone of ice cream. A rope on a pole.

At the end of the maze, Lina said, "We did it!"
Miles said, "Magic e helps me."
They took a final step and high-fived. Then they made one more card, just for fun: "Smile."`
    },
    {
        id: 'blends-camp',
        title: 'Blends at Camp',
        gradeBand: '3-5',
        lexileBand: 'Developing',
        focus: 'Initial blends',
        passage: `The class went on a camp trek to practice outdoor skills. Their guide, Mr. Brooks, gave them a simple plan: hike, stop at the stream, and build a shelter that could block wind.

Before they left, the class checked supplies. They had a map, a compass, a tarp, and string. Each group also had a small snack pack. Sam brought granola bars. Mei brought apples. Luis brought crackers.

On the trail, the path split. Mr. Brooks said, "Stop. Look. Think." The class stood still and listened. Birds chirped. Leaves rustled. A squirrel sprinted across a log.
"Which way?" asked Sam.
"Let's read the map," said Mei. They found the creek line and the little bridge symbol. Then they chose the path that curved toward it.

At the stream, the water was clear and cold. The groups practiced skipping stones, but only for a minute. "Skills first," Mr. Brooks reminded them.
Next, they planned shelters. One group tried a lean-to. Another group tried a low A-frame. Sam's group used the tarp like a slanted roof. They stretched it tight and tied knots so it would not slip.

When the wind picked up, the shelters mattered. Leaves blew past in quick bursts. Sam tested the tarp and grinned. "It holds!"
Mr. Brooks gave a thumbs-up. "Strong knots. Smart plan."

Before heading back, the class reflected. They did not just hike; they practiced planning, teamwork, and clear communication. Sam wrote in his notebook: "Blends are like teams, too. Two sounds stick together, but you can still hear each one."`
    },
    {
        id: 'digraph-mystery',
        title: 'Digraph Mystery',
        gradeBand: '3-5',
        lexileBand: 'Developing',
        focus: 'Digraphs',
        passage: `The ship drifted past the shore when the wind shifted. Captain Shaw grabbed the rail and shouted, "Watch the waves!"

The crew moved fast. One sailor checked the chart. Another sailor hauled a rope. A third sailor watched the lighthouse flash.
"We should turn," said the captain. "If we drift too far, we will miss the dock."

Then something odd happened. A small flag near the bow flapped in a strange rhythm: flap-flap, pause, flap.
"That looks like a signal," said Nia, the youngest sailor on the crew.
Captain Shaw frowned. "A signal from who?"

Nia scanned the water. She saw a shape near the rocks. At first, it looked like driftwood. Then it shifted.
"A boat," she said. "Someone is waving."

The crew threw a line. The little boat bumped gently against the ship. Inside was a wet backpack and a notebook wrapped in plastic.
Captain Shaw opened the notebook. On the first page, a message was written in neat print:
"If you find this, please help. I tried to reach the shore, but the wind pushed me back. Follow the light, then head south."

"The lighthouse," said Nia.
Captain Shaw nodded. "We were focused on the waves. We almost missed the clue."

They turned the ship toward the lighthouse and followed the flashing beam. Soon the water calmed. The dock appeared, just where the chart said it would be.
As they tied the ship in place, Captain Shaw looked at Nia. "Great thinking," he said. "You noticed the signal and solved the mystery."

Nia smiled. "Digraphs are like clues," she said. "Two letters, one sound, and you have to watch closely."`
    },
    {
        id: 'r-controlled-rescue',
        title: 'R-Controlled Rescue',
        gradeBand: '3-5',
        lexileBand: 'Developing',
        focus: 'R-controlled vowels (ar, er, ir, or, ur)',
        passage: `The day of the park clean-up began with a surprise storm. Dark clouds rolled in, and the air turned sharp and cool.

Ms. Carter pointed to the shelter by the corner of the field. "We will wait there," she said. "Safety first."

The class hurried across the grass. A gust of wind stirred leaves into a swirl. A few trash bags tipped over and skittered.
"We should secure the bags," said Jordan. "Or they will blow everywhere."

Ms. Carter nodded. "Smart," she said. "Grab the string from the cart."

Jordan tied a knot around the bags and then heard a small chirp. He turned toward the oak tree near the border of the playground.
"Did you hear that?" he asked.

Mira listened. "A bird," she said. "Maybe it fell from a nest."

They looked under the tree and found a tiny bird shivering near a dark patch of dirt. Its feathers were wet, and it could not fly.
Jordan felt his heart thump. "We should help it," he said.

Ms. Carter called the office, and the counselor arrived with a warm towel and a box. They carefully moved the bird into the box.
"You did the right thing," the counselor said. "You stayed calm and asked for support."

When the storm passed, the class returned to the work with a stronger spirit. They picked up litter near the curb, carried sticks to the bin, and sorted recycling.
At the end, Jordan wrote in his reflection: "Our class helped in a storm. We used teamwork, and we cared."`
    },
    {
        id: 'vowel-team-quest',
        title: 'Vowel Team Quest',
        gradeBand: '6-8',
        lexileBand: 'Fluent',
        focus: 'Vowel teams',
        passage: `The team found clues on the trail, taped to trees like tiny flags. Each clue had a pattern to decode: vowel teams, silent letters, and tricky prefixes.

Their guide, Ms. Reed, held up a rule card. "When you see two vowels together," she said, "try a vowel team sound first. If it does not work, try another strategy."

The first clue read: "Follow the trail until you reach the creek." Kai circled the vowel team in "creek."
"That's /ee/," he said. "Like in tree."

The second clue read: "Look for a sign near the road." Amina pointed to "road."
"That's /oa/," she said. "Like boat."

The trail grew steeper. The team stayed close and read each sign out loud, taking turns so everyone practiced. When someone got stuck, they did not rush ahead. They paused, broke the word into parts, and tried again.

At the ridge, the last clue waited under a flat stone: "You are near the clearing."
"Near has /ear/," said Kai.
"Clearing has /air/," said Amina. "Two vowel teams in one clue."

They followed the final path and reached a green clearing that looked like a secret room in the forest. Someone had hung a small banner between two branches: "Great reading, team."

Ms. Reed smiled. "Notice what you did," she said. "You used patterns, you listened, and you supported each other. That is how strong readers work: together, with strategies."

The team cheered, but the best part was quieter: the moment when a hard word became clear because everyone stayed patient.`
    },
    {
        id: 'kindness-council',
        title: 'Kindness Council',
        gradeBand: '6-8',
        lexileBand: 'Fluent',
        focus: 'Prosody and punctuation',
        passage: `On Monday, the teacher wrote two words on the board: "KIND" and "CLEAR."
Then she asked the class to form a circle.

"Today we will practice communication," she said. "Not just what we say, but how we say it."

The class read a short script with dialogue. There were questions, exclamations, and pauses.
"Are you okay?" asked one student.
"I thought you were ignoring me!" said another.
"I was nervous," the first student replied. "I needed a minute."

When they finished, the teacher asked, "What did you notice?"
One student said, "The punctuation helped. The question mark changed my voice."
Another student said, "The pause after a period made it easier to understand."

Next, the class tried again. This time, they focused on three targets:
1) Pause at punctuation.
2) Change intonation for questions.
3) Use a calm pace, even when the text feels emotional.

After two rounds, the circle felt different. Students listened more closely. They waited before reacting. They asked better questions.

At the end, the teacher said, "Reading and speaking are connected. When we read with prosody, we practice empathy: we try to understand how someone feels and why."
The class wrote a one-sentence reflection. Many students chose the same word: "respect."`
    },
    {
        id: 'multi-syllable',
        title: 'Multi-Syllable Mission',
        gradeBand: '9-12',
        lexileBand: 'Advanced',
        focus: 'Multi-syllable decoding',
        passage: `The community center organized a volunteer project to renovate the reading lounge. The plan sounded simple: paint, sort books, set up new signage. In practice, the work required coordination.

Students collaborated in small teams. One team inventoried supplies and created a checklist. Another team reorganized the shelves by genre and reading level. A third team designed informative posters for visitors, including a short description of each section.

During the project, a teacher paused the group for a quick mini-lesson on vocabulary and decoding. "In high school," she said, "we still use the same core skills. When you meet a long word, do not guess. Break it into parts."

She wrote examples on the whiteboard:
re-organ-ize, in-form-a-tive, col-lab-o-rate, com-mu-ni-ty.
"Look for prefixes, roots, and suffixes," she added. "Then connect meaning."

The students tried it. A sign-design team debated the best word for their poster:
Should it say "accessible," "welcoming," or "inclusive"?
They discussed nuance and tone, not just spelling.

By the end of the day, the lounge looked different. The shelves were clear. The labels made sense. The posters invited people to explore.
One student stepped back and said, "This feels like more than painting. It feels like we built a system."

That sentence captured the purpose of the project: strong literacy tools help people organize ideas, communicate clearly, and make spaces more usable for everyone.`
    },
    {
        id: 'science-brief',
        title: 'Science Briefing',
        gradeBand: '9-12',
        lexileBand: 'Advanced',
        focus: 'Academic vocabulary',
        passage: `During the briefing, the researcher explained how the experiment measured temperature changes in a closed container. The class was not expected to memorize every detail. Instead, they were asked to track the logic: question, method, data, conclusion.

First, the researcher defined the variables. The independent variable was the amount of light. The dependent variable was the temperature change over time.
Next, she described the procedure. Each trial used the same container, the same starting temperature, and the same time window. Only the light level changed.

Then the data appeared on the screen as a clean graph. The line rose quickly, leveled off, and rose again when the light increased.
"What pattern do you notice?" the researcher asked.

Students offered ideas. One student pointed out the plateau, and another explained that the system reached a temporary balance.
The researcher nodded. "Good. You are interpreting, not guessing."

After the discussion, the teacher assigned a short response: summarize the results in one paragraph, then explain one limitation of the experiment.
To support students, the teacher provided a sentence frame:
"The data suggest that ______ because ______."

The point of the task was bigger than science content. It was practice in academic literacy: using precise vocabulary, following reasoning, and writing clearly about evidence.`
    }
];

const gradeSelect = document.getElementById('fluency-grade');
const lexileSelect = document.getElementById('fluency-lexile');
const passageSelect = document.getElementById('fluency-select');
const passageEl = document.getElementById('fluency-passage');
const titleEl = document.getElementById('fluency-title');
const metaEl = document.getElementById('fluency-meta');
const timerDisplay = document.getElementById('fluency-timer-display');
const timerSelect = document.getElementById('fluency-minutes');
const startBtn = document.getElementById('fluency-start');
const pauseBtn = document.getElementById('fluency-pause');
const resetBtn = document.getElementById('fluency-reset');
const wordsInput = document.getElementById('fluency-words');
const errorsInput = document.getElementById('fluency-errors');
const goalInput = document.getElementById('fluency-goal');
const scoreOutput = document.getElementById('fluency-score');
const feedbackEl = document.getElementById('fluency-feedback');
const coinsEl = document.getElementById('fluency-coins');
const streakEl = document.getElementById('fluency-streak');
const scoreBtn = document.getElementById('fluency-check');

function applyLightTheme() {
    document.body.classList.add('force-light');
    document.documentElement.classList.add('force-light');
    document.documentElement.style.colorScheme = 'light';
}

const STATE_KEY = 'fluency_progress';
const FILTER_KEY = 'fluency_filters_v1';
let progress = { coins: 0, streak: 0 };
let timerId = null;
let remainingSeconds = 60;
let currentDuration = 60;
let currentPassage = null;

let trackerTokens = [];
let trackerStopIndex = null; // 1-based index of last word read
let trackerErrors = new Set(); // 1-based indices
let trackerMode = 'errors'; // 'errors' | 'stop'

function normalizeTokenForCount(token) {
    if (!token) return '';
    return token.toString().replace(/^[^A-Za-z0-9]+|[^A-Za-z0-9]+$/g, '');
}

function tokenizePassage(text) {
    return (text || '')
        .toString()
        .replace(/\s+/g, ' ')
        .trim()
        .split(' ')
        .filter(Boolean);
}

function safeParse(json) {
    try {
        return JSON.parse(json);
    } catch {
        return null;
    }
}

function getDefaultGradeBand() {
    try {
        const profile = window.DECODE_PLATFORM?.getProfile?.();
        return profile?.gradeBand || '';
    } catch (e) {
        return '';
    }
}

function ensureTrackerUI() {
    const panel = passageEl?.closest('.fluency-panel');
    if (!panel) return;
    if (document.getElementById('fluency-tracker')) return;

    const tracker = document.createElement('div');
    tracker.id = 'fluency-tracker';
    tracker.className = 'fluency-tracker';
    tracker.innerHTML = `
        <div class="fluency-tracker-row">
            <div class="fluency-tracker-buttons">
                <button id="fluency-set-stop" class="secondary-btn" type="button">Set stop word</button>
                <button id="fluency-clear-marks" class="secondary-btn" type="button">Clear marks</button>
            </div>
            <div class="fluency-tracker-stats" aria-label="Tracker stats">
                <span>Stop: <strong id="fluency-stop-label">‚Äî</strong></span>
                <span>Errors: <strong id="fluency-error-label">0</strong></span>
                <span>Words: <strong id="fluency-wordcount-label">0</strong></span>
            </div>
        </div>
        <div class="fluency-tracker-hint">
            Click a word to mark an error. Press ‚ÄúSet stop word‚Äù, then click the last word read.
        </div>
    `;

    panel.querySelector('.fluency-panel-header')?.insertAdjacentElement('afterend', tracker);

    tracker.querySelector('#fluency-set-stop')?.addEventListener('click', () => {
        trackerMode = 'stop';
        feedbackEl.textContent = 'Click the last word read.';
        tracker.classList.add('stop-mode');
    });

    tracker.querySelector('#fluency-clear-marks')?.addEventListener('click', () => {
        clearTrackerMarks();
    });
}

function clearTrackerMarks() {
    trackerStopIndex = null;
    trackerErrors = new Set();
    trackerMode = 'errors';
    document.getElementById('fluency-tracker')?.classList.remove('stop-mode');
    passageEl?.querySelectorAll('.fluency-word').forEach(wordEl => {
        wordEl.classList.remove('error', 'stop', 'after-stop');
    });
    syncTrackerToInputs();
}

function syncTrackerLabels() {
    const stopLabel = document.getElementById('fluency-stop-label');
    const errorLabel = document.getElementById('fluency-error-label');
    const wordcountLabel = document.getElementById('fluency-wordcount-label');

    const stopDisplay = trackerStopIndex ? String(trackerStopIndex) : '‚Äî';
    if (stopLabel) stopLabel.textContent = stopDisplay;

    const errorsWithinRange = Array.from(trackerErrors).filter(idx => !trackerStopIndex || idx <= trackerStopIndex);
    if (errorLabel) errorLabel.textContent = String(errorsWithinRange.length);

    const countable = trackerTokens.map(normalizeTokenForCount).filter(Boolean);
    if (wordcountLabel) wordcountLabel.textContent = String(countable.length);
}

function syncTrackerToInputs() {
    const countable = trackerTokens.map(normalizeTokenForCount).filter(Boolean);
    const wordCount = countable.length;

    const wordsRead = trackerStopIndex ? Math.min(trackerStopIndex, wordCount) : 0;
    const errors = Array.from(trackerErrors).filter(idx => idx <= (trackerStopIndex || wordCount)).length;

    if (wordsRead) {
        wordsInput.value = String(wordsRead);
    } else if (trackerStopIndex === null) {
        // Leave teacher input alone if they are typing manually.
    }

    errorsInput.value = String(errors);
    syncTrackerLabels();
}

function applyStopHighlighting() {
    passageEl?.querySelectorAll('.fluency-word').forEach(wordEl => {
        const idx = Number(wordEl.dataset.index || 0);
        wordEl.classList.toggle('after-stop', !!trackerStopIndex && idx > trackerStopIndex);
        wordEl.classList.toggle('stop', !!trackerStopIndex && idx === trackerStopIndex);
    });
}

function renderTrackablePassage(text) {
    ensureTrackerUI();
    trackerTokens = tokenizePassage(text);
    trackerStopIndex = null;
    trackerErrors = new Set();
    trackerMode = 'errors';
    document.getElementById('fluency-tracker')?.classList.remove('stop-mode');

    passageEl.innerHTML = '';
    trackerTokens.forEach((token, i) => {
        const idx = i + 1;
        const span = document.createElement('span');
        span.className = 'fluency-word';
        span.dataset.index = String(idx);
        span.textContent = token;

        span.addEventListener('click', () => {
            if (trackerMode === 'stop') {
                trackerStopIndex = idx;
                trackerMode = 'errors';
                document.getElementById('fluency-tracker')?.classList.remove('stop-mode');
                feedbackEl.textContent = 'Stop word set. Mark any errors (tap words).';
                applyStopHighlighting();
                syncTrackerToInputs();
                return;
            }

            if (trackerErrors.has(idx)) {
                trackerErrors.delete(idx);
                span.classList.remove('error');
            } else {
                trackerErrors.add(idx);
                span.classList.add('error');
            }
            syncTrackerToInputs();
        });

        passageEl.appendChild(span);
        passageEl.appendChild(document.createTextNode(' '));
    });

    syncTrackerLabels();
}

function loadProgress() {
    try {
        const saved = JSON.parse(localStorage.getItem(STATE_KEY));
        if (saved) progress = { ...progress, ...saved };
    } catch (e) {}
}

function saveProgress() {
    localStorage.setItem(STATE_KEY, JSON.stringify(progress));
}

function updateHud() {
    coinsEl.textContent = progress.coins;
    streakEl.textContent = progress.streak;
}

function buildFilters() {
    const gradeBands = Array.from(new Set(FLUENCY_PASSAGES.map(p => p.gradeBand)));
    const lexileBands = Array.from(new Set(FLUENCY_PASSAGES.map(p => p.lexileBand)));
    gradeSelect.innerHTML = gradeBands.map(band => `<option value="${band}">${band}</option>`).join('');
    lexileSelect.innerHTML = ['All'].concat(lexileBands).map(band => `<option value="${band}">${band}</option>`).join('');
}

function loadFilters() {
    const parsed = safeParse(localStorage.getItem(FILTER_KEY) || '');
    if (parsed?.grade && Array.from(gradeSelect.options).some(o => o.value === parsed.grade)) {
        gradeSelect.value = parsed.grade;
    } else {
        const fallback = getDefaultGradeBand();
        if (fallback && Array.from(gradeSelect.options).some(o => o.value === fallback)) {
            gradeSelect.value = fallback;
        }
    }

    if (parsed?.lexile && Array.from(lexileSelect.options).some(o => o.value === parsed.lexile)) {
        lexileSelect.value = parsed.lexile;
    }
}

function saveFilters() {
    localStorage.setItem(FILTER_KEY, JSON.stringify({
        grade: gradeSelect.value,
        lexile: lexileSelect.value
    }));
}

function buildPassageList() {
    const grade = gradeSelect.value;
    const lexile = lexileSelect.value;
    let pool = FLUENCY_PASSAGES.filter(p => p.gradeBand === grade);
    if (lexile !== 'All') {
        pool = pool.filter(p => p.lexileBand === lexile);
    }
    if (pool.length === 0) pool = FLUENCY_PASSAGES;

    passageSelect.innerHTML = pool.map(p => `<option value="${p.id}">${p.title}</option>`).join('');
    currentPassage = pool[0];
    renderPassage();
}

function renderPassage() {
    if (!currentPassage) return;
    titleEl.textContent = currentPassage.title;
    const wc = tokenizePassage(currentPassage.passage).map(normalizeTokenForCount).filter(Boolean).length;
    metaEl.textContent = `Grade ${currentPassage.gradeBand} ‚Ä¢ Lexile band: ${currentPassage.lexileBand} ‚Ä¢ Focus: ${currentPassage.focus} ‚Ä¢ Words: ${wc}`;
    renderTrackablePassage(currentPassage.passage);
}

function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m}:${String(s).padStart(2, '0')}`;
}

function updateTimerDisplay() {
    timerDisplay.textContent = formatTime(remainingSeconds);
}

function startTimer() {
    if (timerId) return;
    timerId = setInterval(() => {
        remainingSeconds = Math.max(0, remainingSeconds - 1);
        updateTimerDisplay();
        if (remainingSeconds <= 0) {
            stopTimer();
            feedbackEl.textContent = '‚è±Ô∏è Time! Enter words read and errors to score.';
        }
    }, 1000);
}

function stopTimer() {
    if (timerId) {
        clearInterval(timerId);
        timerId = null;
    }
}

function resetTimer() {
    stopTimer();
    remainingSeconds = currentDuration;
    updateTimerDisplay();
}

function updateDuration() {
    const minutes = Math.max(1, Number(timerSelect.value) || 1);
    currentDuration = minutes * 60;
    remainingSeconds = currentDuration;
    updateTimerDisplay();
}

function scoreFluency() {
    // If the teacher used the tracker, prefer those values.
    if (trackerStopIndex) {
        syncTrackerToInputs();
    }
    const words = Number(wordsInput.value || 0);
    const errors = Number(errorsInput.value || 0);
    const minutes = currentDuration / 60;
    const orf = Math.max(0, words - errors) / minutes;
    scoreOutput.textContent = orf.toFixed(1);

    const goal = Number(goalInput.value || 0);
    if (goal && orf >= goal) {
        progress.coins += 2;
        progress.streak += 1;
        feedbackEl.textContent = 'üèÖ Goal reached! Coins awarded.';
    } else if (goal) {
        progress.streak = 0;
        feedbackEl.textContent = 'Keep going! Try again to beat the goal.';
    } else {
        feedbackEl.textContent = 'Score saved. Set a goal if you want rewards.';
    }
    saveProgress();
    updateHud();

    try {
        const reached = goal ? orf >= goal : null;
        window.DECODE_PLATFORM?.logActivity?.({
            activity: 'fluency',
            label: 'Speed Sprint',
            event: goal ? (reached ? `Goal met: ${orf.toFixed(1)} WCPM` : `Scored: ${orf.toFixed(1)} WCPM`) : `Scored: ${orf.toFixed(1)} WCPM`,
            detail: {
                passageId: currentPassage?.id,
                title: currentPassage?.title,
                gradeBand: currentPassage?.gradeBand,
                lexileBand: currentPassage?.lexileBand,
                focus: currentPassage?.focus,
                goal: goal || null,
                orf: Number(orf.toFixed(1)),
                words,
                errors
            }
        });
    } catch (e) {}
}

function init() {
    applyFriendlyNavLabels();
    applyLightTheme();
    applyPlatformGameModeVisibility();
    loadProgress();
    updateHud();
    buildFilters();
    loadFilters();
    buildPassageList();
    updateDuration();

    gradeSelect.addEventListener('change', () => {
        saveFilters();
        buildPassageList();
    });
    lexileSelect.addEventListener('change', () => {
        saveFilters();
        buildPassageList();
    });
    passageSelect.addEventListener('change', () => {
        const selected = FLUENCY_PASSAGES.find(p => p.id === passageSelect.value);
        if (selected) currentPassage = selected;
        renderPassage();
    });

    timerSelect.addEventListener('change', updateDuration);
    startBtn.addEventListener('click', startTimer);
    pauseBtn.addEventListener('click', stopTimer);
    resetBtn.addEventListener('click', resetTimer);
    scoreBtn.addEventListener('click', scoreFluency);
}

init();

function applyPlatformGameModeVisibility() {
    const active = isPlatformGameModeActive();
    const hud = document.querySelector('.fluency-hud');
    if (hud) hud.style.display = active ? 'flex' : 'none';
}

function isPlatformGameModeActive() {
    try {
        const raw = localStorage.getItem('decode_settings');
        if (!raw) return false;
        const parsed = JSON.parse(raw);
        const enabled = !!parsed?.funHud?.enabled;
        const active = !!parsed?.gameMode?.active;
        const hasModes = !!parsed?.gameMode?.teamMode || !!parsed?.gameMode?.timerEnabled || !!parsed?.funHud?.challenge;
        return enabled && active && hasModes;
    } catch (e) {
        return false;
    }
}

function applyFriendlyNavLabels() {
    const map = {
        'Cloze': 'Story Fill',
        'Comprehension': 'Read & Think',
        'Fluency': 'Speed Sprint',
        'Mad Libs': 'Silly Stories'
    };
    document.querySelectorAll('a, button').forEach((el) => {
        const label = (el.textContent || '').trim();
        if (map[label]) {
            el.textContent = map[label];
        }
    });
}
